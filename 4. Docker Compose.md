# Docker Compose

Referensi: https://docs.docker.com/compose/

Secara singkat, dokcer compose adalah sebuah alat atau tools yang dapat digunakan untuk mendefine ataupun menjalankan beberapa service atau container sekaligus secara otomatis, termasuk dalam pull imagenya, build image, mengatur portnya, menambahkan environment/properties, ataupun mengatur network dari setiap container agar dapat saling berkomunikasi.

Berikut adalah command yang ada dalam docker compose:

![image](https://github.com/ferdyansahalfariz/balajarDocker/assets/96871156/8949316e-ccbd-4e77-97de-567eef318f4d)

## Praktek

Sebelum mulai praktek, pastikan docker compose sudah terinstall dengan command docker compose version. Jika belum maka install terlebih dahulu [disini](https://docs.docker.com/compose/install/)

Pada praktek kali ini, saya akan membuat docker compose yang akan berisi 2 service antara lain yang pertama yaitu postgres dan juga aplikasi java yang berguna untuk demo graphql yang ada pada tutorial [ini](https://spring.io/guides/gs/graphql-server).

Jalankan perintah `mvn clean package` untuk project java sampai menghasilkan file jar lalu buat file Dockerfile berikut:

```
# Gunakan image openjdk sebagai base image
FROM openjdk:17

# Salin JAR ke dalam direktori kerja di dalam image
COPY target/bookDetails-0.0.1-SNAPSHOT.jar app.jar

# Tentukan perintah untuk menjalankan aplikasi
CMD ["java", "-jar", "app.jar"]
```

Dockerfile akan pull image `openjdk:17` sebagai basenya dan akan membuat image baru berdasarkan project java yang sudah dibuat packagenya di file jar.

Buat file docker-compose.yml dengan isi berikut:

```
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    networks:
      - my-network
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5433/mydatabase
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
    depends_on:
      - postgres

  postgres:
    image: postgres:latest
    volumes:
      - ./volumes/postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: mydatabase
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"  # Menggunakan port 5433 di host
    networks:
      - my-network

networks:
  my-network:
    driver: bridge
```

Penjelasan:
* Version merupakan versi yang diterapkan untuk menjalankan docker compose. lihat [disini](https://docs.docker.com/compose/release-notes/) untuk melihat versi lainnya.
* services akan berisi setiap container yang akan dibuat, antara lain ada app dan postgres. Untuk postgres, container akan mengambil image dari `postgres:latest`, lalu mengatur volume tempat data disimpan, disini saya mengaturnya untuk diletakan di folder ./volumes/postgres-data agar saat container dihapus, data masih akan tersimpan dalam direktori tersebut.

* adapun environtment yang digunakan untuk container postgres yaitu nama database, user dan password akan di define disini serta dimana port dari host akan diteruskan ke port containernya. karena di hostname saya sudah menginstall postgres pada port 5432, maka saya akan meneruskannya pada port 5433.

* Kemudian untuk container app yang berisi program java, akan dilakukan build terlebih dahulu berdasarkan Dockerfile yang sudah dibuat, serta diatur environmentnya agar depend_on atau bergantung kepada container postgres.

* Untuk network sendiri, digunakan untuk setiap container dapat berkomunikasi satu sama lainnya dan tidak terisolasi.

* Jalankan perintah `docker compose up --build -d` untuk run file docker-compose.yaml dan membuat container yang sudah di define. Berikut adalah hasil saat di jalankan.

* ![image](https://github.com/ferdyansahalfariz/balajarDocker/assets/96871156/1630e9a4-2a78-4a0e-89fd-92fbbb37cdff)

Dibawah ini terlihat kedua service atau container sudah berjalan pada portnya

![image](https://github.com/ferdyansahalfariz/balajarDocker/assets/96871156/32b4fa0c-5e31-4585-9277-590155605649)

Berikut adalah program javanya sudah running di port 8080

![image](https://github.com/ferdyansahalfariz/balajarDocker/assets/96871156/a7b7777c-5f9c-4326-ae7e-4f638d64bf92)

Dan service atau container postgres juga sudah running di port 5433

![image](https://github.com/ferdyansahalfariz/balajarDocker/assets/96871156/e413f31d-2005-4188-a2d1-4d91fb64b5de)


